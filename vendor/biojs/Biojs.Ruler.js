
Biojs.Ruler=Biojs.extend({_number:1,constructor:function(options){var self=this;var target=self.opt.target;var innerCode='  <section class="ruler">';innerCode+='   <section class="active_rules">';innerCode+='    <header>Created Rules</header>';innerCode+='     <ul id="'+target+'_list" class="sortable"> ';innerCode+='     </ul>';innerCode+='   </section>';innerCode+='   <section class="rules_editor">';innerCode+='    <header>New Rule</header>';innerCode+='    <div id="'+target+'_add_rule" class="add_rule"><a>+ Add Rule</a></div>';innerCode+='    <ul id="'+target+'_list_to_add">';innerCode+='    </ul>';innerCode+='   </section>';innerCode+='  </section>';$("#"+target).append(innerCode);if(self.opt.allowOrdering==true){$(".sortable").sortable({stop:function(event,ui){self.raiseEvent('onOrderChanged',{rules:self.getActiveRules()});}});$(".sortable").disableSelection();}else
$(".sortable").removeClass("sortable");$("#"+target+"_add_rule a").click(function(){self.addRule();});},opt:{target:"YourOwnDivId",rules:null,allowOrdering:true},eventTypes:["onRuleCreated","onRuleRemoved","onOrderChanged","onRuleEditing"],getActiveRules:function(){var self=this;var rules=new Array();$("#"+self.opt.target+'_list > li').each(function(){rules.push($(this).data("rule"))});return rules;},setAffectedByRule:function(ruleId,affected){var self=this;$("#"+ruleId+" .affected").html(affected);},changeRules:function(rules){var self=this;self.opt.rules=rules;},addRule:function(rule){var self=this;var target=self.opt.target;var number=self._number;var code_rule=' <li id="rule_'+number+'"  class="rule_item"><table><tr><td class="rule">';var gotRule=!(typeof rule=="undefined");var selectedTarget=0;if(typeof self.opt.rules.location!='undefined'&&self.opt.rules.location.length>0){code_rule+="In";code_rule+=self._getSelect('location_'+number,self.opt.rules.location,"",gotRule?rule.location:rule);}
if(gotRule)
for(var i in self.opt.rules.target)
if(self.opt.rules.target[i].name==rule.target)
selectedTarget=i;code_rule+='  <span id="action_span_'+number+'" >'+self._getActionSpan(number,selectedTarget,rule)+'</span>';code_rule+='  the ';code_rule+=self._getSelect('target_'+number,self.opt.rules.target,"name",gotRule?rule.target:rule);code_rule+='  with ';var visible=gotRule?"none":"inline";for(var i in self.opt.rules.target){visible=gotRule?((self.opt.rules.target[i].name==rule.target)?"inline":"none"):visible;code_rule+=self._getConditionsSpan(number,self.opt.rules.target[i],visible,rule);visible="none";}
code_rule+=' </td> ';code_rule+='  <td><span class="action" id="'+target+'_apply_rule_'+number+'">APPLY</span></td> ';code_rule+='</tr></table></li>';$("#"+target+'_list_to_add').append(code_rule);$("#"+target+"_apply_rule_"+number).click(function(){self._applyRule($(this));});$("#target_"+number).change(function(){var n=$(this)[0].id.substr($(this)[0].id.lastIndexOf("_")+1);for(var i in self.opt.rules.target){var target_name=self.opt.rules.target[i].name;var target_id=target_name.replace(/ /g,"");$("#conditions_"+n+"_"+target_id).css("display","none");}
$("#target_"+n+" option:selected").each(function(){$("#conditions_"+n+"_"+$(this).text()).css("display","inline");$("#condition_params_"+n+"_"+$(this).text()+"_"+($("#condition_"+n+"_"+$(this).text()).val().replace(/ /g,""))).css("display","inline");$('#action_span_'+n).html(self._getActionSpan(n,$(this).parent()[0].selectedIndex));self._enableAction(n);});});self._enableAction(number,rule);for(var i in self.opt.rules.target){var target_name=self.opt.rules.target[i].name;var target_id=target_name.replace(/ /g,"");$("#condition_"+number+"_"+target_id).change(function(){var parts=$(this)[0].id.split("_");$("#condition_"+parts[1]+"_"+parts[2]+" option").each(function(){$("#condition_params_"+parts[1]+"_"+parts[2]+"_"+($(this).text().replace(/ /g,""))).css("display","none");});$("#condition_"+parts[1]+"_"+parts[2]+" option:selected").each(function(){$("#condition_params_"+parts[1]+"_"+parts[2]+"_"+($(this).text().replace(/ /g,""))).css("display","inline");});});}
self._number++;},addActiveRule:function(rule,n){var self=this;var target=self.opt.target;if(typeof n=="undefined"){n=self._number++;rule.id=target+'_rule_'+n;}
var parameter_span="";switch(rule.action.type){case"color":parameter_span='<span style="color: '+rule.actionParameters[0]+'; background-color: '+rule.actionParameters[0]+';">_</span>';break;case"colorRange":parameter_span='<span style="color: '+rule.actionParameters[0]+'; background-color: '+rule.actionParameters[0]+';">_</span>';parameter_span+='<span style="color: '+rule.actionParameters[1]+'; background-color: '+rule.actionParameters[1]+';">_</span>';break;case"select":parameter_span='<i>'+rule.actionParameters[0]+'</i>';break;}
var locText=(typeof rule.location=='undefined')?'':'In <i>'+rule.location+'</i> ';$("#"+target+'_list').append('<li id="'+target+'_rule_'+n+'" class="rule_item"><table><tr><td class="rule"'+locText+'<i>'+rule.action.name+'</i> '+parameter_span+' the <i>'+rule.target+'</i> with <i>'+rule.condition+' '+rule.parameters.join(" ")+' </i>  </td> <td><span class="action remove">remove</span> <span class="action edit">edit</span></td> <td class="rights"><span class="affected">0</span></td></tr></table></li>');$('#'+target+'_rule_'+n).data("rule",rule);$('#'+target+'_rule_'+n+' span.remove').click(function(){var removed=$(this).parent().parent().parent().parent().parent().data("rule");$(this).parent().parent().parent().parent().parent().remove();self.raiseEvent('onRuleRemoved',{rules:self.getActiveRules(),removed:removed});});$('#'+target+'_rule_'+n+' span.edit').click(function(){var editing=$(this).parent().parent().parent().parent().parent().data("rule");$(this).parent().parent().parent().parent().parent().remove();self.addRule(editing);self.raiseEvent('onRuleEditing',{rules:self.getActiveRules(),editing:editing});});self.raiseEvent('onRuleCreated',{rules:self.getActiveRules(),new_rule:$('#'+target+'_rule_'+n).data("rule")});},_applyRule:function(clicked){var self=this;var target=self.opt.target;var n=clicked[0].id.substr(clicked[0].id.lastIndexOf("_")+1);var location=$('#location_'+n).val();var actionName=$('#action_'+n).val();var target1=$('#target_'+n).val();var action=self._getAction(target1,actionName);var condition=$('#condition_'+n+'_'+target1.replace(/ /g,"")).val();var parameters=new Array();var par=0;while(typeof $('#condition_params_'+n+'_'+target1+'_'+condition.replace(/ /g,"")+'_'+par).val()!="undefined"){parameters.push($('#condition_params_'+n+'_'+target1+'_'+condition.replace(/ /g,"")+'_'+par).val());par++;}
var actionPar=[];switch(action.type){case"color":actionPar.push($("#action_parameters_0_"+n).val());break;case"colorRange":actionPar.push($("#action_parameters_0_"+n).val());actionPar.push($("#action_parameters_1_"+n).val());break;case"select":actionPar.push($("#action_parameters_0_"+n).val());break}
var rule={location:location,action:action,actionParameters:actionPar,target:target1,condition:condition,parameters:parameters,id:target+'_rule_'+n};self.addActiveRule(rule,n);clicked.parent().parent().parent().parent().parent().remove();},_getConditionsSpan:function(n,target,visible,rule){var self=this;var target_name=target.name;var target_id=target_name.replace(/ /g,"");var code_rule='  <span id="conditions_'+n+'_'+target_id+'" style="display:'+visible+'"> ';var gotRule=!(typeof rule=="undefined");code_rule+=self._getSelect('condition_'+n+'_'+target_id,target.conditions,"name",gotRule?rule.condition:rule);var visible_p=gotRule?"none":"inline";for(var j in target.conditions){visible_p=gotRule?((target.conditions[j].name==rule.condition)?"inline":"none"):visible_p;code_rule+=self._getConditionSpan(n,target_id,target.conditions[j],visible_p,rule);visible_p="none";}
code_rule+='  </span> ';return code_rule;},_getConditionSpan:function(n,target_id,condition,visible_p,rule){var self=this;var condition_name=condition.name;var condition_id=condition_name.replace(/ /g,"");var gotRule=!(typeof rule=="undefined");var code_rule='  <span id="condition_params_'+n+'_'+target_id+'_'+condition_id+'" style="display:'+visible_p+'"> ';switch(condition.type){case"selects":for(var i=0;i<1*condition.amount;i++)
code_rule+=self._getSelect('condition_params_'+n+'_'+target_id+'_'+condition_id+'_'+i,condition.values,"",gotRule?rule.parameters[i]:rule);break;case"numeric_comparison":code_rule+=self._getSelect('condition_params_'+n+'_'+target_id+'_'+condition_id+'_0',["==",">","<",">=","<="],"",gotRule?rule.parameters[0]:rule);var value=gotRule?rule.parameters[1]:"";code_rule+='  <input type="number" id="condition_params_'+n+'_'+target_id+'_'+condition_id+'_1" value="'+value+'">';break;case"text_comparison":code_rule+=self._getSelect('condition_params_'+n+'_'+target_id+'_'+condition_id+'_0',["equals","contains","different","not contains"],"",gotRule?rule.parameters[0]:rule);var value=gotRule?rule.parameters[1]:"";code_rule+='  <input type="text" id="condition_params_'+n+'_'+target_id+'_'+condition_id+'_1"  value="'+value+'">';break;case"feature_comparison":code_rule+=self._getSelect('condition_params_'+n+'_'+target_id+'_'+condition_id+'_0',condition.values,"",gotRule?rule.parameters[0]:rule);code_rule+=self._getSelect('condition_params_'+n+'_'+target_id+'_'+condition_id+'_1',["equals","contains","different","not contains"],"",gotRule?rule.parameters[1]:rule);var value=gotRule?rule.parameters[2]:"";code_rule+='  <input type="text" id="condition_params_'+n+'_'+target_id+'_'+condition_id+'_2"  value="'+value+'">';break;case"all":break;}
code_rule+='  </span>';return code_rule;},_getSelect:function(id,options,field,selected){var code='  <select  id="'+id+'" class="styled-select">';for(var i in options){var value=options[i];if(typeof field!="undefined"&&field!="")value=options[i][field];var selector=(value==selected)?"selected='selected'":"";code+='   <option '+selector+'>'+value+'</option>';}
code+='  </select> ';return code;},_getActionSpan:function(number,selectedTarget,rule){var self=this;var gotRule=!(typeof rule=="undefined");var code=self._getSelect('action_'+number,self.opt.rules.target[selectedTarget].action,"name",gotRule?rule.action.name:rule);code+='  <span id="action_parameters_'+number+'" > </span>';return code;},_enableAction:function(number,rule){var self=this;var gotRule=!(typeof rule=="undefined");$("#action_"+number).change(function(){var n=$(this)[0].id.substr($(this)[0].id.lastIndexOf("_")+1);self._enableActionParameters(n);});self._enableActionParameters(number,rule);},_enableActionParameters:function(number,rule){var self=this;var gotRule=!(typeof rule=="undefined");var action=(gotRule)?self._getAction(rule.target,rule.action.name):self._getAction($('#target_'+number).val(),$('#action_'+number).val());$("#action_parameters_"+number).html('');switch(action.type){case"color":self._addColorSelector(number,0,(gotRule)?rule.actionParameters[0]:rule);break;case"colorRange":self._addColorSelector(number,1,(gotRule)?rule.actionParameters[0]:"#F00");self._addColorSelector(number,0,(gotRule)?rule.actionParameters[1]:"#0F0");break;case"select":$("#action_parameters_"+number).html(self._getSelect('action_parameters_0_'+number,action.options,"",gotRule?rule.actionParameters[0]:rule));break
case"single":default:$("#action_parameters_"+number).html('');}},_addColorSelector:function(n,parameter,color){color=(typeof color!="undefined")?color:'#56992F';$("#action_parameters_"+n).append('<input type="hidden" id="action_parameters_'+parameter+'_'+n+'" name="color4" class="color-picker" size="6" />')
$("#action_parameters_"+parameter+"_"+n).miniColors({letterCase:'uppercase'}).miniColors('value',color);},_getAction:function(targetName,actionName){var self=this;for(var i=0;i<self.opt.rules.target.length;i++){var target=self.opt.rules.target[i];if(target.name==targetName){for(var j=0;j<target.action.length;j++){var action=target.action[j];if(action.name==actionName)
return action;}}}}});