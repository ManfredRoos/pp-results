
Biojs.EbiGlobalSearch=Biojs.extend({constructor:function(options){this.setQuery(this.opt.query);},opt:{target:"YourOwnDivId",query:undefined,searchBaseURL:'http://www.ebi.ac.uk/ebisearch/',style:'collapsible'},setQuery:function(query,style){this._completedRequest=false;if(typeof style!='undefined'){this.opt.style=style;}
if(typeof query!='undefined'){this.opt.query=query;this._drawTemplate();if(this.opt.style!=Biojs.EbiGlobalSearch.VIEW_COLLAPSIBLE){this._updateSummary();}}else{var message="ERROR: Query error: "+Biojs.EbiGlobalSearch.QUERY_ERROR_UNDEFINED;Biojs.console.log(message);this.raiseEvent(Biojs.EbiGlobalSearch.EVT_ON_ERROR,{message:message});}},setStyle:function(style){this.setQuery(this.opt.query,style);},_updateSummary:function(){var self=this;var url=this.opt.searchBaseURL+"globalsearchsummary.ebi?query="+this.opt.query;jQuery.ajax({url:url,context:this,dataType:"json"}).done(function(response){Biojs.console.log("SUCCESS: data received");self._completedRequest=true;self._drawResults(response)}).fail(function(jqXHR,textStatus){var errorMessage="ERROR: Request failed: "+textStatus;if(this.opt.query==""){errorMessage=errorMessage+": Empty query";}
Biojs.console.log(errorMessage);self.raiseEvent(Biojs.EbiGlobalSearch.EVT_ON_ERROR,{"message":errorMessage});self._drawResults(errorMessage);});},_renderItem:function(ul,item){jQuery("<li>").append(jQuery("<a>").attr("href",this.opt.searchBaseURL+item.url).text(item.name+" ("+item.numberOfResults+")")).appendTo(ul);},_renderItems:function(response,ul){var self=this;var totalNumberOfResults=0;var totalNumberOfServices=0;var totalNumberOfServicesWithResults=0;jQuery.each(response,function(index,item){totalNumberOfServices++;if(item.numberOfResults!=0){self._renderItem(ul,item);totalNumberOfResults+=parseInt(item.numberOfResults);totalNumberOfServicesWithResults++;}});if(totalNumberOfResults==0){var noResultsMessage="No results for \""+this.opt.query+"\"";var search_extras=jQuery("#"+Biojs.EbiGlobalSearch.SEARCH_EXTRAS);search_extras.find("ul").css("display","none");search_extras.find("p").text(noResultsMessage);}
this.raiseEvent(Biojs.EbiGlobalSearch.EVT_ON_RESULTS,{"resutls":totalNumberOfResults,"services":totalNumberOfServices,"servicesWithResults":totalNumberOfServicesWithResults,"items":response});},_drawTemplate:function(){if(this.opt.style.toLowerCase()==Biojs.EbiGlobalSearch.VIEW_BASIC){var thisElem=jQuery("#"+this.opt.target);thisElem.html("");var search_extras=jQuery("<aside id='"+Biojs.EbiGlobalSearch.SEARCH_EXTRAS+"'></aside>");search_extras.appendTo(thisElem);search_extras.removeClass("shortcuts");search_extras.text("Loading other results");search_extras.addClass("loading");}else if(this.opt.style.toLowerCase()==Biojs.EbiGlobalSearch.VIEW_COLLAPSIBLE){var self=this;var thisElem=jQuery("#"+this.opt.target);thisElem.html("");var search_extras=jQuery("<aside id='"+Biojs.EbiGlobalSearch.SEARCH_EXTRAS+"'></aside>");search_extras.appendTo(thisElem);search_extras.addClass("shortcuts expander");var ebi_search_results=jQuery("<div id='"+Biojs.EbiGlobalSearch.EBI_SEARCH_RESULTS+"'></div>");ebi_search_results.appendTo(search_extras);var h3=jQuery("<h3 data-icon='u'>Show more data from EMBL-EBI</h3>");h3.addClass("slideToggle icon icon-functional");h3.appendTo(ebi_search_results);jQuery('#ebi_search_results .slideToggle[data-icon="u"]').next().hide();jQuery("#ebi_search_results .slideToggle").click(function(){jQuery(this).attr("data-icon")==='u'?jQuery(this).attr("data-icon","w"):jQuery(this).attr("data-icon","u");if(jQuery(this).attr("data-icon")==='w'){if(self._completedRequest!=true){h3.addClass("loading");self._updateSummary();}}
jQuery(this).parent().find("p").slideToggle(300);jQuery(this).parent().find("ul").slideToggle(300);});}else{var thisElem=jQuery("#"+this.opt.target);thisElem.html("");var search_extras=jQuery("<aside id='"+Biojs.EbiGlobalSearch.SEARCH_EXTRAS+"'></aside>");search_extras.appendTo(thisElem);search_extras.addClass("shortcuts");var ebi_search_results=jQuery("<div id='"+Biojs.EbiGlobalSearch.EBI_SEARCH_RESULTS+"'></div>");ebi_search_results.appendTo(search_extras);var h3=jQuery("<h3>More data from EMBL-EBI</h3>");h3.addClass("loading");h3.appendTo(ebi_search_results);}},_drawResults:function(response){var self=this;if(this.opt.style.toLowerCase()==Biojs.EbiGlobalSearch.VIEW_BASIC){var search_extras=jQuery("#"+Biojs.EbiGlobalSearch.SEARCH_EXTRAS);search_extras.html("");search_extras.removeClass("loading");search_extras.append("<p>EBI global search results</p>");if(typeof response!="string"){var ul=jQuery("<ul>").appendTo(search_extras);self._renderItems(response,ul);}else{jQuery("<p>"+response+"</p>").appendTo(search_extras);}}else if(this.opt.style.toLowerCase()==Biojs.EbiGlobalSearch.VIEW_COLLAPSIBLE){var self=this;var ebi_search_results=jQuery("#"+Biojs.EbiGlobalSearch.EBI_SEARCH_RESULTS);jQuery(ebi_search_results).find("h3").removeClass("loading");jQuery(ebi_search_results).find("ul").remove();jQuery(ebi_search_results).find("p").remove();if(typeof response!="string"){var p=jQuery("<p>Other results for \""+this.opt.query+"\"</p>");p.appendTo(ebi_search_results);var ul=jQuery("<ul>");ul.attr("id","global-search-results");ul.appendTo(ebi_search_results);self._renderItems(response,ul);}else{jQuery("<p>"+response+"</p>").appendTo(ebi_search_results);}}else{var ebi_search_results=jQuery("#"+Biojs.EbiGlobalSearch.EBI_SEARCH_RESULTS);jQuery(ebi_search_results).find("h3").removeClass("loading");if(typeof response!="string"){var p=jQuery("<p>Other results for \""+this.opt.query+"\"</p>");p.appendTo(ebi_search_results);var ul=jQuery("<ul>");ul.attr("id","global-search-results");ul.appendTo(ebi_search_results);self._renderItems(response,ul);}else{jQuery("<p>"+response+"</p>").appendTo(ebi_search_results);}}},eventTypes:["onError","onResults"]},{QUERY_ERROR_UNDEFINED:"Query undefined",QUERY_ERROR_USER_MESSAGE:"Sorry, we could not process your request",EVT_ON_ERROR:"onError",EVT_ON_RESULTS:"onResults",EBI_SEARCH_RESULTS:'ebi_search_results',SEARCH_EXTRAS:'search-extras',VIEW_BASIC:'basic',VIEW_COLLAPSIBLE:'collapsible',VIEW_EXPANDED:'expanded'});