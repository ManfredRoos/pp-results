<head>

<link rel="stylesheet" href="../biojs/dependencies/jquery/jquery.tooltip.css"/>
<link rel="stylesheet" href="../biojs/dependencies/jquery/jquery-ui-1.8.2.css">
<script language="JavaScript" type="text/javascript" src="../biojs/dependencies/jquery/jquery-1.4.2.min.js"></script>
<script type="text/javascript">
jQuery.noConflict();

jQuery(document).ready(function($){
	

	var sequenceLineY = 54;
	        
	$.get("data/source4.xml",
		function (data){
			
			var array =  buildFeature(data);
			var json =  setUpFeatureMap( data, array );
			var myPainter = new Biojs.FeatureViewer({
	   			target: "FeatureMap",
	   			json: json,
	   // featureImageWebService: "http://wwwdev.ebi.ac.uk/uniprot/featureViewer/image"
			});
		},
		"xml");
		
		// .fail(function() {
		//  alert("error"); 
		// });

String.prototype.capitalize = function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
}

	function colorPicker( ann_type, subann_type){
		color = 'black';

		 switch (ann_type){
			case 'secondary structures':
					switch (subann_type){
						case 'helix':
						color = '#990000';
						break;
						case 'strand':
				        color = '#0000CC';
			  		  	break;
			        default:
			        	color = '#006600';
			        	break;
					}
					break;
				case 'helical transmembrane region':
					color = '#990099';
					break;
				case 'protein binding region':
					color = 'pink';
					break;
				case 'NORSnet':
					color = 'grey';
					break;
				case 'disulfide bond':
					color = 'brown';
					break;
				case 'PROFbval':
					color = 'green';
					break;
				case 'Ucon':
					color = 'yellow';
					break;
				case 'MD':
					color = 'orange';
					break;
				case 'alignment':
					color = 'blue';
					break;

	    }

	    return (color);
	}


	function buildFeature(xml_doc){

		var element_count = 0;
		var track_number = 0;
		var track_height = 0;
		
		var color = 'white';

		var features_array = [];
		var annotation_types = ['secondary structures', 'helical transmembrane region', 'protein binding region', 'disulfide bond'];

		jQuery.each(annotation_types, function(index, value) {
			$(xml_doc).find('featureTypeGroup[type='+value+'] feature').each(function(){
			   	var feature = addAnnotation ( value, index, $(this) ) ;
			    // console.log(feature);
			    features_array.push(feature);
			})
			element_count++;
		});

		var disorder_types = ['NORSnet', 'PROFbval', 'Ucon', 'MD'];
		jQuery.each(disorder_types, function(index, value) {
			$(xml_doc).find('featureProviderGroup[provider='+value+'] feature').each(function(){
			   	var feature = addAnnotation ( value, element_count, $(this) ) ;
			    //console.log(feature);
			    features_array.push(feature);
			})
			element_count++;
		});

		console.log(element_count);
		element_count = element_count*7;
		$(xml_doc).find('alignment').each(function(){
			value = 'alignment';
			pos_start = Math.max ($(this).find('queryStart').attr('value'),$(this).find('subjectStart').attr('value') );
			pos_stop = Math.min ($(this).find('queryEnd').attr('value'),$(this).find('subjectEnd').attr('value') );
			if (pos_stop<pos_start)
				console.log(pos_stop+"  "+pos_start);
		   	else{
		   		var feature = addAnnotation ( value, element_count, $(this), 1, pos_start, pos_stop ) ;
		   // console.log(feature);
		    	features_array.push(feature);
		    	element_count++;
		    	}
		})
		return (features_array);
	} 



	function addAnnotation ( name, ann_number, data, height, pos_start, pos_stop ){
		    var baseLineY = sequenceLineY+2;
		    track_height=10;

		    if ( height ) track_height = height;
		    track_margin=10;
		     if (name == 'alignment') track_margin=2;
		
		 	var element_type = $(data).attr("type");
		 	var pos_begin, pos_end;
		 	if (pos_start)
		 		pos_begin=pos_start;
		 	else
		    	pos_begin  = $(data).find('begin').attr('position');

		    if (pos_stop)
		    	pos_end = pos_stop;
		    else
		    	pos_end  = $(data).find('end').attr('position');

		    color = colorPicker(name,element_type);
		    value_text = name.capitalize();
		    if (element_type)
		    	element_type_text  = element_type.capitalize();
		    var feature = {
			    "type":"rect",
			    "featureStart":pos_begin,
				"featureEnd":pos_end,
				"fillOpacity":0.5,
				"fill": color,
	            "stroke":color,
	            "height":track_height,
	            "strokeWidth":0,
	            "y":baseLineY + (ann_number*(track_height+track_margin)),
				"evidenceText": "Prediction",
			    "typeLabel": value_text,
				"typeLabel": value_text,
				"featureLabel":element_type_text, 
				"typeCategory": value_text,
				"typeCode":"SO:0001062",
				"evidenceCode":"",
				"featureId": "ann"+ann_number+pos_begin,
				"featureTypeLabel": value_text + "-" + element_type_text
		    }
		    return (feature);
	}

	function setUpFeatureMap( xml_doc, features_array){
	 	var seq = $(xml_doc).find("sequence").text();
 		seq = $.trim(seq).replace(/(\r\n|\n|\r)/gm,"");

		w = $('#FeatureMap').width();
		//w = w -50;
		sequenceLength = seq.length;

		var json = {
		    "featuresArray":features_array
		    ,"segment":"CD44_HUMAN"
		    ,"legend":{
		        "segment":{"yPosCentered":190,"text":"","yPos":300,"xPos":15,"yPosNonOverlapping":106,"yPosRows":290}
		        ,"key":[
		            // {
		            //     "label":{
		            //         "total":"1","yPosCentered":210,"text":"Peptide","yPos":326,"xPos":50
		            //         ,"yPosNonOverlapping":126,"yPosRows":310
		            //     }
		            //     ,"shape":{
		            //         "centeredStyle":{"heightOrRadius":5,"y":208},"text":""
		            //         ,"nonOverlappingStyle":{"heightOrRadius":5,"y":321},"width":30,"fill":"#7DBAA4"
		            //         ,"cy":121,"cx":15,"type":"rect","fillOpacity":0.5,"stroke":"#7DBAA4","height":5,"r":10
		            //         ,"path":"","rowsStyle":{"heightOrRadius":5,"y":305},"typeLabel":"Peptide","y":321
		            //         ,"strokeWidth":1,"x":15
		            //     }
		            // }
		            // ,{
		            //     "label":{
		            //         "total":"1","yPosCentered":210,"text":"Propeptide","yPos":326,"xPos":205
		            //         ,"yPosNonOverlapping":126,"yPosRows":310
		            //     }
		            //     ,"shape":{
		            //         "centeredStyle":{"heightOrRadius":5,"y":208},"text":""
		            //         ,"nonOverlappingStyle":{"heightOrRadius":5,"y":321},"width":30,"fill":"#9B7057"
		            //         ,"cy":121,"cx":170,"type":"rect","fillOpacity":0.5,"stroke":"#9B7057","height":5,"r":10
		            //         ,"path":"","rowsStyle":{"heightOrRadius":5,"y":305},"typeLabel":"Propeptide","y":321
		            //         ,"strokeWidth":1,"x":170
		            //     }
		            // }
		        ]
		    }
		    ,"configuration":{
		        "requestedStop":sequenceLength,
		        "horizontalGridNumLines":1,
		        "sequenceLineYCentered":95,
		        "requestedStart":1
		        ,"gridLineHeight":12,
		        "rightMargin":5,
		        "leftMargin":5,
		        "belowRuler":30,
		        "sequenceLength":sequenceLength
		        ,"horizontalGridNumLinesNonOverlapping":2,
		        "horizontalGridNumLinesCentered":6
		        ,"verticalGridLineLengthRows":284,
		        "unitSize":6.875,
		        "sizeYNonOverlapping":76,
		        "style":"nonOverlapping",
		        "sequenceLineYRows":155,
		        "sequenceLineY":54,
		        "verticalGrid":false,
		        "rulerY":20
		        ,"dasSources":"http://www.ebi.ac.uk/das-srv/uniprot/das/uniprot",
		        "horizontalGrid":false
		        ,"pixelsDivision":50,
		        "sizeY":600,
		        "sizeX":w
		        ,"dasReference":"http://www.ebi.ac.uk/das-srv/uniprot/das/uniprot",
		        "sizeYRows":260,
		        "aboveRuler":10
		        ,"rulerLength": w,
		        "verticalGridLineLengthNonOverlapping":66,
		        "sizeYKey":210,
		        "sizeYCentered":160
		        ,"sequenceLineYNonOverlapping":54,
		        "verticalGridLineLength":66,
		        "horizontalGridNumLinesRows":8,
		        "nonOverlapping":true,
		        "verticalGridLineLengthCentered":172
		    }
		}

		return (json);
};
 


$('#test').click(function(){
	alert('clicked');
}	);


});



</script>





</head>



<body>
<a id='test' href='#'>test</a>
<div id='container'>
	<div id="FeatureMap"  />
</div>
</body>
<script language="JavaScript" type="text/javascript" src="../biojs//Biojs.js" ></script>
<script language="JavaScript" type="text/javascript" src="../biojs/Biojs.Sequence.js"></script>
<script language="JavaScript" type="text/javascript" src="../biojs/dependencies/jquery/jquery-ui-1.8.2.custom.min.js"></script>
<script language="JavaScript" type="text/javascript" src="../biojs/Biojs.FeatureViewer.js"></script>
<script language="JavaScript" type="text/javascript" src="../biojs/Biojs.HpaSummaryFeature.js"></script>
<script language="JavaScript" type="text/javascript" src="../biojs/dependencies/jquery/jquery.tooltip.js"></script>
<script language="JavaScript" type="text/javascript" src="../biojs/dependencies/jquery/jquery.bgiframe.js"></script>
<script language="JavaScript" type="text/javascript" src="../biojs/dependencies/jquery/jquery.delegate.js"></script>
<script language="JavaScript" type="text/javascript" src="../biojs/dependencies/jquery/jquery.dimensions.min.js"></script>
<script language="JavaScript" type="text/javascript" src="../biojs/dependencies/jquery/jquery.url.js"></script>
<script language="JavaScript" type="text/javascript" src="../biojs/dependencies/graphics/raphael.js"></script>
<script language="JavaScript" type="text/javascript" src="../biojs/dependencies/graphics/canvg.js"></script>
<script language="JavaScript" type="text/javascript" src="../biojs/dependencies/graphics/rgbcolor.js"></script>

	